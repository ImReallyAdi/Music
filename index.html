<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>ImReallyAdi Music</title>

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<script src="https://unpkg.com/@phosphor-icons/web"></script>

<style>
:root {
  --bg:#141218;
  --card:#1e1b24;
  --accent:#d0bcff;
  --text:#e6e1e5;
  --muted:#a6a1ad;
}
*{box-sizing:border-box}
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:system-ui,-apple-system,sans-serif;
  height:100dvh;
  overflow:hidden;
}
main{
  padding:20px;
  height:calc(100dvh - 90px);
  overflow-y:auto;
}
.track{
  display:flex;
  gap:12px;
  padding:12px;
  border-radius:14px;
  background:var(--card);
  margin-bottom:10px;
}
.track i{font-size:1.4rem;color:var(--accent)}
.track-title{font-weight:600}
.track-artist{font-size:.85rem;color:var(--muted)}
.fab{
  position:fixed;
  right:20px;
  bottom:110px;
  width:56px;
  height:56px;
  border:none;
  border-radius:16px;
  background:var(--accent);
  font-size:1.6rem;
}
.mini{
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  height:90px;
  background:var(--card);
  display:flex;
  align-items:center;
  padding:0 16px;
  gap:12px;
}
.mini button{
  background:none;
  border:none;
  color:var(--accent);
  font-size:1.6rem;
}
.hidden{display:none}
</style>
</head>

<body>

<main>
  <h1>Library</h1>
  <div id="list"></div>
</main>

<button class="fab" id="addBtn">
  <i class="ph ph-plus"></i>
</button>

<input id="fileInput" type="file" accept="audio/*" multiple hidden>

<div class="mini hidden" id="mini">
  <div style="flex:1">
    <div id="nowTitle" class="track-title">—</div>
    <div id="nowArtist" class="track-artist">—</div>
  </div>
  <button id="playBtn"><i class="ph ph-play-fill"></i></button>
</div>

<script>
/* ---------- SAFARI-SAFE AUDIO ---------- */
const audio = new Audio();
audio.setAttribute('playsinline','');
audio.setAttribute('webkit-playsinline','');

let audioUnlocked = false;
function unlockAudio(){
  if(audioUnlocked) return;
  audio.play().then(()=>{
    audio.pause();
    audioUnlocked = true;
  }).catch(()=>{});
}

/* ---------- INDEXEDDB ---------- */
const DB = 'adi-music-db';
const STORE = 'tracks';
const VERSION = 3;

let db;
let tracks = [];
let current = -1;

function openDB(){
  return new Promise(res=>{
    const req = indexedDB.open(DB, VERSION);
    req.onupgradeneeded = e=>{
      const db = e.target.result;
      if(!db.objectStoreNames.contains(STORE)){
        db.createObjectStore(STORE,{keyPath:'id',autoIncrement:true});
      }
    };
    req.onsuccess = e=>res(e.target.result);
  });
}

function saveFiles(files){
  const tx = db.transaction(STORE,'readwrite');
  const store = tx.objectStore(STORE);

  [...files].forEach(f=>{
    store.add({
      name: f.name.replace(/\.[^/.]+$/,''),
      artist: 'Unknown',
      blob: new Blob([f],{type:f.type})
    });
  });

  tx.oncomplete = loadTracks;
}

function loadTracks(){
  const tx = db.transaction(STORE,'readonly');
  const store = tx.objectStore(STORE);
  store.getAll().onsuccess = e=>{
    tracks = e.target.result;
    render();
  };
}

/* ---------- UI ---------- */
function render(){
  const list = document.getElementById('list');
  list.innerHTML = '';

  if(!tracks.length){
    list.innerHTML = '<p style="opacity:.6">no music yet. tap +</p>';
    return;
  }

  tracks.forEach((t,i)=>{
    const d = document.createElement('div');
    d.className = 'track';
    d.innerHTML = `
      <i class="ph ph-music-note"></i>
      <div>
        <div class="track-title">${t.name}</div>
        <div class="track-artist">${t.artist}</div>
      </div>
    `;
    d.onclick = ()=>{
      unlockAudio();
      play(i);
    };
    list.appendChild(d);
  });
}

function play(i){
  current = i;
  const t = tracks[i];
  audio.src = URL.createObjectURL(t.blob);
  audio.play();

  nowTitle.textContent = t.name;
  nowArtist.textContent = t.artist;
  mini.classList.remove('hidden');
  playBtn.innerHTML = '<i class="ph ph-pause-fill"></i>';
}

playBtn.onclick = ()=>{
  unlockAudio();
  if(audio.paused){
    audio.play();
    playBtn.innerHTML = '<i class="ph ph-pause-fill"></i>';
  }else{
    audio.pause();
    playBtn.innerHTML = '<i class="ph ph-play-fill"></i>';
  }
};

/* ---------- EVENTS ---------- */
addBtn.onclick = ()=>{
  unlockAudio();
  fileInput.click();
};

fileInput.onchange = e=>{
  if(e.target.files.length){
    saveFiles(e.target.files);
  }
  fileInput.value = '';
};

/* ---------- START ---------- */
openDB().then(d=>{
  db = d;
  loadTracks();
});
</script>

</body>
</html>
